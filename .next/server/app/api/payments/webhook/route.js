"use strict";(()=>{var e={};e.id=1004,e.ids=[1004],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},54195:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>y,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{POST:()=>d,dynamic:()=>u});var s=r(22060),o=r(72433),n=r(10137),i=r(16097),p=r(68664),c=r(20095);let u="force-dynamic";async function d(e){let t;let r=process.env.STRIPE_SECRET_KEY,a=process.env.STRIPE_WEBHOOK_SECRET;if(!r||!a)return i.NextResponse.json({error:"Stripe not configured"},{status:500});let s=new p.Z(r,{apiVersion:"2024-06-20"}),o=e.headers.get("stripe-signature"),n=await e.text();try{t=s.webhooks.constructEvent(n,o,a)}catch(e){return console.error("[payments] webhook signature error:",e),new i.NextResponse("Invalid signature",{status:400})}try{let e=await (0,c.createClient)();switch(t.type){case"checkout.session.completed":{let r=t.data.object,a=r.metadata?.case_id,s=r.metadata?.user_id,o=r.metadata?.payment_row_id;o&&await e.from("payments").update({payment_status:"completed"}).eq("id",o),a&&s&&await e.from("cases").update({status:"intake",updated_at:new Date().toISOString()}).eq("id",a);break}case"payment_intent.succeeded":{let r=t.data.object;await e.from("payments").update({payment_status:"completed"}).eq("stripe_payment_intent_id",r.id);break}case"checkout.session.expired":{let r=t.data.object,a=r.metadata?.payment_row_id;a&&await e.from("payments").update({payment_status:"failed"}).eq("id",a)}}return i.NextResponse.json({received:!0})}catch(e){return console.error("[payments] webhook handler error:",e),new i.NextResponse("Webhook handler failed",{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"/workspaces/cursor-guidebuoy-ai-sg/app/api/payments/webhook/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:x,serverHooks:y}=l,h="/api/payments/webhook/route";function _(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:x})}},20095:(e,t,r)=>{r.r(t),r.d(t,{createClient:()=>o});var a=r(54778),s=r(4599);async function o(){let e=await (0,s.cookies)();return(0,a.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:a})=>e.set(t,r,a))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[2461,9582,3364,8664],()=>r(54195));module.exports=a})();